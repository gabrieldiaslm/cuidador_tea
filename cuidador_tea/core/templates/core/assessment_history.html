{% extends "core/base.html" %}

{% block content %}
  <h1>Hist√≥rico de Avalia√ß√µes</h1>
  <p>Perfil: <strong>{{ profile.name }}</strong></p>

  {% if results %}
  <details class="assessment-accordion chart-accordion" style="border-left: 5px solid var(--cor-primaria); margin-bottom: 25px;">
      <summary class="assessment-summary" style="background-color: #f0f7ff;">
        <div class="summary-info">
          <span class="summary-title">üìà Evolu√ß√£o de Pontua√ß√£o Geral</span>
        </div>
        <div class="summary-score">
          <span class="icon">‚ñº</span>
        </div>
      </summary>
      <div class="assessment-details">
          <div class="chart-container" style="position: relative; height:250px; width:100%">
              <canvas id="evolutionChart"></canvas>
          </div>
      </div>
  </details>
  {% endif %}

  {% for result in results %}
    <details class="assessment-accordion">
      <summary class="assessment-summary">
        <div class="summary-info">
          <span class="summary-date">{{ result.completed_at|date:"d/m/Y" }}</span>
          <span class="summary-title">{{ result.assessment.title }}</span>
        </div>
        <div class="summary-score">
          <strong>Nota: {{ result.get_total_score }}</strong>
          <span class="icon">‚ñº</span>
        </div>
      </summary>

      <div class="assessment-details">
        <div class="section-results-grid">
          {% for sec_res in result.section_results.all %}
            <div class="section-box" style="border-left-color: 
              {% if sec_res.score <= 3 %}#dc3545
              {% elif sec_res.score <= 6 %}#ffc107
              {% else %}#28a745{% endif %};">
              
              <div class="section-header-row" style="display: flex; justify-content: space-between; align-items: center;">
                <strong>{{ sec_res.section.title }}</strong>
                
                {% with diff=sec_res.get_comparison %}
                  {% if diff is not None %}
                    {% if diff > 0 %}
                      <span class="trend up">‚ñ≤ +{{ diff }}</span>
                    {% elif diff < 0 %}
                      <span class="trend down">‚ñº {{ diff }}</span>
                    {% else %}
                      <span class="trend stable">=</span>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              </div>

              <div class="progress-container">
                <div class="progress-bar 
                  {% if sec_res.score <= 3 %}bg-red
                  {% elif sec_res.score <= 6 %}bg-yellow 
                  {% else %}bg-green{% endif %}" 
                  style="width: {{ sec_res.score }}0%;">
                </div>
              </div>
              
              <div class="score-display">
                <span>Nota: <strong>{{ sec_res.score }}/10</strong></span>
              </div>

              <details class="tip-accordion">
                  <summary class="tip-header">
                      <span>üí° Ver Dica Pedag√≥gica</span>
                      <span class="icon">‚ñº</span>
                  </summary>
                  <div class="tip-content">
                      <p>{{ sec_res.get_tip|default:"Sem orienta√ß√µes para esta pontua√ß√£o." }}</p>
                  </div>
              </details>
            </div>
          {% endfor %}
        </div>
      </div>
    </details>
  {% empty %}
    <p>Ainda n√£o h√° avalia√ß√µes conclu√≠das.</p>
  {% endfor %}

  <br>
  <a href="{% url 'home' %}" class="button">Voltar para Home</a>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('evolutionChart');
        if (!ctx) return;

        // Invertemos os dados com 'reversed' para o gr√°fico ir da esquerda (antigo) para a direita (novo)
        const labels = [{% for r in results  %}"{{ r.completed_at|date:'d/m' }}",{% endfor %}];
        const dataPoints = [{% for r in results  %}{{ r.get_total_score }},{% endfor %}];

        const evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pontos Totais',
                    data: dataPoints,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 40 }
                }
            }
        });

        // TRUQUE PARA RENDERIZAR AO ABRIR:
        // Como o gr√°fico come√ßa escondido, precisamos avisar ao Chart.js para se redimensionar ao abrir
        document.querySelector('.chart-accordion').addEventListener('toggle', function() {
            if (this.open) {
                evolutionChart.resize();
            }
        });
    });
  </script>
{% endblock %}